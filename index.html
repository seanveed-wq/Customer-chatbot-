<script>
  const input = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const messages = document.getElementById("messages");
  const typingIndicator = document.getElementById("typingIndicator");

  // Fix 1: Aapka naya Production URL
  const N8N_WEBHOOK_URL = "https://sanveesd.app.n8n.cloud/webhook/chat-bot";

  function addMessage(text, type) {
    const msg = document.createElement("div");
    msg.className = "message " + type;
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    
    // Fix 2: Safety check agar response JSON object ho
    bubble.innerText = (typeof text === 'object') ? (text.output || text.text || JSON.stringify(text)) : text;
    
    msg.appendChild(bubble);
    messages.appendChild(msg);
    messages.scrollTop = messages.scrollHeight;
  }

  async function sendMessageToN8N(userMessage) {
    typingIndicator.style.display = "block";
    sendBtn.disabled = true;

    try {
      // Fix 3: Fetch call with proper headers for Production URL
      const response = await fetch(N8N_WEBHOOK_URL, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          chatInput: userMessage // n8n AI Agent expect karta hai
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      
      // Fix 4: Data extraction (aapne respond node mein 'output' map kiya hai)
      const aiText = data.output || data.text || data || "Sorry, I couldn't get a response.";
      
      addMessage(aiText, "ai");
    } catch (error) {
      console.error("Error details:", error);
      addMessage("Connection error. Please ensure the workflow is SAVED and ACTIVE in n8n.", "ai");
    } finally {
      typingIndicator.style.display = "none";
      sendBtn.disabled = false;
      input.focus();
    }
  }

  sendBtn.onclick = () => {
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    input.value = "";
    sendMessageToN8N(text);
  };

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") sendBtn.click();
  });
</script>
  
